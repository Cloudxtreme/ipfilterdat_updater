#!/bin/bash
#  ipfilterdat-updater
#  
#  Copyright 2015 loxdegio <loxdegio@hotmail.com>
#  
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.
#  
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#  
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
#  MA 02110-1301, USA.
#  
#

tmpdir=/tmp/ipfilter
destdir=~/.aMule

mkdir $tmpdir

wget http://upd.emule-security.org/ipfilter.zip -O $tmpdir/ipfilter.zip
unzip $tmpdir/ipfilter.zip -d $tmpdir
cat $tmpdir/guarding.p2p >> $tmpdir/ipfilter_dat.tmp
wget http://up.sur-la-toile.com/i1cde -O $tmpdir/ipfilter.7z
7z e -so $tmpdir/ipfilter.7z >> $tmpdir/ipfilter_dat.tmp
wget http://loxtestspace.altervista.org/ipfilterdat/ipfilter_emule-mods.v0153.dat -O $tmpdir/ipfilter_emule-mods.v0153.dat
cat $tmpdir/ipfilter_emule-mods.v0153.dat >> $tmpdir/ipfilter_dat.tmp
for i in cn eu hk it jp kp kr ru us; do
	wget http://tools.pervii.com/$i/ipfilter.dat.txt -O $tmpdir/ipfilter_dat-$i.txt
	cat $tmpdir/ipfilter_dat-$i.txt | sed -e 's/[0-9]-/&\ /g' -e 's/- [0-9]/\ &/g' | sed -e "s/$/ , 000 , From $i-ipfilter.dat/g" >> $tmpdir/ipfilter_dat.tmp
done

cat $tmpdir/ipfilter_dat.tmp | grep -v '#' > $tmpdir/ipfilter_dat.tmp1

echo '## Generated by ipfilterdat-updater script' > $destdir/ipfilter_dat.tmp

cat $tmpdir/ipfilter_dat.tmp1 | sort | uniq > $tmpdir/ipfilter_dat.tmp2
echo "## Filtrati $(cat $tmpdir/ipfilter_dat.tmp2 | wc -l) IP" >> $destdir/ipfilter_dat.tmp

cat $tmpdir/ipfilter_dat.tmp2 >> $destdir/ipfilter_dat.tmp

mv $destdir/ipfilter{_dat.tmp,.dat}

rm -rf $tmpdir
